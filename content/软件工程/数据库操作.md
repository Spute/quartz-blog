---
title: 数据库操作
---

## 什么是事务（Transaction）

事务 = 一组要么全部成功、要么全部失败的数据库操作。

特点（ACID）：

- <strong>原子性 (Atomicity)</strong>：要么全做，要么全不做
- <strong>一致性 (Consistency)</strong>：事务前后数据库状态一致
- <strong>隔离性 (Isolation)</strong>：事务之间互不干扰
- <strong>持久性 (Durability)</strong>：提交后数据永久保存

---

## 数据库隔离

<strong>PostgreSQL</strong>

- 默认隔离级别：`READ COMMITTED`

<strong>MySQL</strong>

- 默认隔离级别：`REPEATABLE READ`

为什么要“隔离”？，设想两个事务同时运行：

- 事务 A：`用户1 从账户扣钱`
- 事务 B：`用户2 查询账户余额`

如果没有“隔离”，B 可能读到 A 还没提交的数据，导致出现“脏数据”。
所以需要规定事务之间的 <strong>隔离级别</strong>。

---

### SQL 标准的四种隔离级别

从低到高：

1. <strong>READ UNCOMMITTED（读未提交）</strong>

   - 事务能读到其他事务未提交的数据（脏读）。
   - 最快，但最不安全。
2. <strong>READ COMMITTED（读已提交）</strong>

   - 只能读到已提交的数据，避免脏读。
   - 但可能出现“不可重复读”。
   - <strong>PostgreSQL 默认</strong>。
3. <strong>REPEATABLE READ（可重复读）</strong>

   - 在同一个事务里，多次读取同一行数据，结果保持一致。
   - 避免不可重复读，但可能有“幻读”。
   - <strong>MySQL 默认</strong>。
4. <strong>SERIALIZABLE（可串行化）</strong>

   - 所有事务严格按顺序执行，就像串行一样。
   - 最安全，但性能最低。
   - <strong>SQLite 默认</strong>（但通过整表锁实现）。

---

1. 对应的并发问题

👉 <strong>事务隔离就是数据库保证并发执行时，多个事务互不干扰的机制；隔离级别越高，数据越一致，但并发性能越低</strong>。

## 数据库隔离等级

Mysql 数据库的默认隔离等级是“可重复读”，并的请求时，会产生幻读，可能导致创建重复数据的情况。

## 解决幻读的两种思路

### 方法 A：<strong>使用更高的隔离级别</strong>

- <strong>SERIALIZABLE</strong> 隔离级别
  - 数据库会把查询和范围锁结合起来，阻止其他事务插入/删除会影响你查询条件的数据行。
  - 缺点：并发性能低，容易产生锁等待。

---

### 方法 B：<strong>显式加锁</strong>

在查询时加 <strong>行锁或范围锁</strong>，让其他事务无法插入/删除影响的数据行。
