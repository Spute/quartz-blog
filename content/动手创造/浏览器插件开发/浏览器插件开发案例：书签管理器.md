---
title: 浏览器插件开发案例--书签管理器
---

## 演示

这个插件可以快速搜索书签，同时支持编辑、删除和新加书签。

这个功能对于书签很多的朋友，非常友好

![[YzmGbrfhoomuP0xn1vac8HhcnTh.png]]

## 部署包

## 学习知识点

项目结构如下：

使用了之前介绍的 popup 弹窗相关代码，这次引用了第三方包 jquery，被单独放到 third-party 文件夹中

![[BYZZb8djqocwrlxEbl4cfeIrnNd.png]]

<strong>核心代码</strong>

以下是 popup.js 文件代码，这是弹窗的 js 逻辑实现代码

```javascript
// 当输入搜索关键词时，搜索书签
$('#search').change(function () {
  $('#bookmarks').empty();
  dumpBookmarks($('#search').val());
});

// 遍历书签树，打印文件夹和节点
function dumpBookmarks(query) {
  chrome.bookmarks.getTree(function (bookmarkTreeNodes) {
    $('#bookmarks').append(dumpTreeNodes(bookmarkTreeNodes, query));
  });
}

// 遍历节点数组，递归生成书签树结构
function dumpTreeNodes(bookmarkNodes, query) {
  const list = $('<ul>');
  for (let i = 0; i < bookmarkNodes.length; i++) {
    list.append(dumpNode(bookmarkNodes[i], query));
  }

  return list;
}

// 生成单个书签节点的HTML结构
function dumpNode(bookmarkNode, query) {
  let span = '';
  if (bookmarkNode.title) {
    // 如果有查询关键词且是书签（非文件夹），则进行过滤
    if (query && !bookmarkNode.children) {
      if (
        String(bookmarkNode.title.toLowerCase()).indexOf(query.toLowerCase()) ==
        -1
      ) {
        return $('<span></span>');
      }
    }

    const anchor = $('<a>');
    anchor.attr('href', bookmarkNode.url);

    // Chrome 可能有多个同名顶级文件夹，为区分加后缀
    // folderType 只在顶级文件夹有，老版本 Chrome 没有该属性
    let title_text = bookmarkNode.title;
    if (bookmarkNode.folderType) {
      title_text += bookmarkNode.syncing ? ' (Account)' : ' (Local)';
    }
    anchor.text(title_text);

    /*
     * 在扩展中点击书签时，新标签页打开该书签链接
     */
    anchor.click(function () {
      chrome.tabs.create({ url: bookmarkNode.url });
    });

    span = $('<span>');
    // 如果是文件夹，显示添加按钮，否则显示编辑和删除按钮
    const options = bookmarkNode.children
      ? $('<span>[<a href="#" id="addlink">Add</a>]</span>')
      : $(
          '<span>[<a id="editlink" href="#">Edit</a> <a id="deletelink" ' +
            'href="#">Delete</a>]</span>'
        );
    // 编辑表单
    const edit = bookmarkNode.children
      ? $(
          '<table><tr><td>Name</td><td>' +
            '<input id="title"></td></tr><tr><td>URL</td><td><input id="url">' +
            '</td></tr></table>'
        )
      : $('<input>');

    // 鼠标悬停时显示操作按钮
    span
      .hover(
        function () {
          span.append(options);
          // 删除书签
          $('#deletelink').click(function (event) {
            console.log(event);
            $('#deletedialog')
              .empty()
              .dialog({
                autoOpen: false,
                closeOnEscape: true,
                title: 'Confirm Deletion', // 删除确认
                modal: true,
                show: 'slide',
                position: {
                  my: 'left',
                  at: 'center',
                  of: event.target.parentElement.parentElement
                },
                buttons: {
                  'Yes, Delete It!': function () {
                    chrome.bookmarks.remove(String(bookmarkNode.id));
                    span.parent().remove();
                    $(this).dialog('destroy');
                  },
                  Cancel: function () {
                    $(this).dialog('destroy');
                  }
                }
              })
              .dialog('open');
          });
          // 添加书签
          $('#addlink').click(function (event) {
            edit.show();
            $('#adddialog')
              .empty()
              .append(edit)
              .dialog({
                autoOpen: false,
                closeOnEscape: true,
                title: 'Add New Bookmark', // 添加新书签
                modal: true,
                show: 'slide',
                position: {
                  my: 'left',
                  at: 'center',
                  of: event.target.parentElement.parentElement
                },
                buttons: {
                  Add: function () {
                    edit.hide();
                    chrome.bookmarks.create({
                      parentId: bookmarkNode.id,
                      title: $('#title').val(),
                      url: $('#url').val()
                    });
                    $('#bookmarks').empty();
                    $(this).dialog('destroy');
                    window.dumpBookmarks();
                  },
                  Cancel: function () {
                    edit.hide();
                    $(this).dialog('destroy');
                  }
                }
              })
              .dialog('open');
          });
          // 编辑书签
          $('#editlink').click(function (event) {
            edit.show();
            edit.val(anchor.text());
            $('#editdialog')
              .empty()
              .append(edit)
              .dialog({
                autoOpen: false,
                closeOnEscape: true,
                title: 'Edit Title', // 编辑标题
                modal: true,
                show: 'fade',
                position: {
                  my: 'left',
                  at: 'center',
                  of: event.target.parentElement.parentElement
                },
                buttons: {
                  Save: function () {
                    edit.hide();
                    chrome.bookmarks.update(String(bookmarkNode.id), {
                      title: edit.val()
                    });
                    anchor.text(edit.val());
                    options.show();
                    $(this).dialog('destroy');
                  },
                  Cancel: function () {
                    edit.hide();
                    $(this).dialog('destroy');
                  }
                }
              })
              .dialog('open');
          });
          options.fadeIn();
        },

        // 鼠标移出时移除操作按钮
        function () {
          options.remove();
        }
      )
      .append(anchor);
  }

  // 如果有标题则用<li>，否则用<div>
  const li = $(bookmarkNode.title ? '<li>' : '<div>').append(span);

  // 如果有子节点，递归生成子树
  if (bookmarkNode.children && bookmarkNode.children.length > 0) {
    li.append(dumpTreeNodes(bookmarkNode.children, query));
  }

  return li;
}

// 页面加载完成后，初始化书签树
document.addEventListener('DOMContentLoaded', function () {
  dumpBookmarks();
});
```
